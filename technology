# Polkadotのテクノロジー
## レッスン１：ブロックの生成とパラチェーン

###コンセンサスアルゴリズム
Polkadotのコンセンサスは、ハイブリッドコンセンサスと言われます。コンセンサスとは、リレーチェーンに追加する有効なブロックに同意するプロセスです。Polkadotのハイブリットコンセンサスは、ブロックの生成とファイナリティ形成のメカニズムを分けているという特徴があります。

ブロック生成では、BABE（Blind Assignment for Blockchain Extension）という確率的ファイナリティが採用されています。このメカニズムは、Probable Finality（ファイナリティされた可能性が高い)方式です。ブロックが有効＝絶対に覆らないという保証はないメカニズムで、多くのブロックが連なることによってファイナライズ（100%覆らない）に限りなく近づいて行きます。
一方、ファイナリティ形成では、GRANDPA（GHOST-based Recursive ANcestor Deriving Prefix Agreement）という、ビザンチン将軍問題に耐性のあるアルゴリズムに基づいたProvable Finality（証明可能なファイナリティ）を採用しています。ブロックチェーンの正当性（覆らない）は保証されていますが、ノードの数が増えるほど、新規ブロックの追加に時間がかかるデメリットがあります。GRANDPAでは、3分の2以上のバリデータが承認したブロックのファイナリティを保証しています。つまり、Polkadotのコンセンサスは1/3がビザンチンノードでない限りは安全です。

Polkadotではこのふたつのメカニズムを取り入れることで、ブロックチェーンの処理スピードとデータの正当性を維持しています。

###バリデーターとブロック生成
Polkadotのバリデーターは、すべてのスロットで抽選に参加し、そのスロットのブロック生成者の候補として選出されます。スロットは時間単位であり、長さは6秒です。このランダムメカニズムによって、複数のバリデーターが同じスロットの候補になる可能性があります。また、スロットが空になり、ブロック時間が一貫しなくなる場合もあります。
スロットごとに複数のバリデーター
複数のバリデーターが同じスロットのブロック生成者候補となった場合、全ての候補者がブロックを生成し、それをネットワークにブロードキャストします。ブロックがネットワークの大部分に最も早く到達したバリデーターが勝ちます。ネットワークトポロジーとレイテンシーに応じて、ファイナライズが開始されてフォークが切断されるまで、両方のチェーンはある程度の長さまでブロックを構築し続けます。

####フォークの選択
BABEとGRANDPAを組み合わせると、Polkadotのフォークしたチェーンがどう選ばれるかはっきりします。BABEは、常にGRANDPAによって完成されたチェーン上に構築する必要があります。ファイナライズされたヘッドの後にフォークがある場合、BABEは、最も優先順位の高いブロックが確率的なファイナリティを得ます。


####パラチェーン間のトランザクション
それでは、どのようにパラチェーン間でトランザクションがおこなわれるのでしょうか。
トランザクションのフロー
パラチェーンAとパラチェーンBのふたつのパラチェーンがPolkadot上で取引する場合、パラチェーンAからパラチェーンBへトランザクションを送信するフローは以下です。

パラチェーンA から Aのコレーター へTxを送信
コレーターは、Txが有効かどうか確認してからブロックに挿入後、パラチェーンAのバリデーター に状態遷移の証拠を送信
バリデーターは、受け取った有効なTxのブロックを検証し、DOTをそのブロックにステーク
ブロックがリレーチェーンに送信される
Txが実行され、パラチェーンAからパラチェーンBに送信される

このように、異なるブロックチェーン（パラチェーン）間でトランザクションが実行されます。


###パラチェーンのタイプ
Polkadotには複数のパラチェーンのタイプがあり、それぞれが異なる目的があります。
^ ガバナンスで選ばれたパラチェーン
^ オークションで勝ったパラチェーン
^ パラスレッド
パラチェーンは基本的にオークションでパラチェーンスロットを獲得しますが、スロットの一部はシステムレベルのパラチェーンとパラスレッド用に割り当てられます。
ガバナンスで選ばれたパラチェーン
Polkadotのオンチェーンガバナンスによって選択されたパラチェーンです。Polkadotエコシステムの公共事業的なチェーンやシステムレベルのチェーンで「Common Good」と認められたものが選ばれます。
システムレベルのチェーンは、機能をリレーチェーンからパラチェーンに移動し、リレーチェーンのガバナンス上の負担を最小限に抑えることです。例えば、Polkadotのガバナンスプロセスをリレーチェーンからパラチェーンに移動できます。ロジックをパラチェーンに移動することで、Polkadotネットワーク全体の効率をあげることができます。
パブリックユーティリティチェーン（公共事業）は、リレーチェーンのネイティブトークンであるDOTをネイティブトークンとして採用し、リレーチェーンおよびシステムレベルのパラチェーンに確実に準拠するチェーンです。例えば、ブリッジやDOTのスマートコントラクトなどが考えられます。
オークションで勝ったパラチェーン
Polkadotのガバナンスで決まったパラチェーン以外のチェーンは、基本的にこのパラチェーンスロットオークションに参加します。パラチェーンオークションの詳細に関しては、次の章で述べます。
パラチェーンスロットは一定期間リースされます。1スロットの期間は最大2年間で、4つのターム（6か月ごと）に区切られています。つまり、パラチェーンプロジェクトは最大4つの連続したタームを借りることができます。リース期間が終了すると、もう一度オークションに参加して勝ち取る必要があります。つまり、資金力のあるパラチェーンプロジェクトは最初から最大スロット数を使用し、そうでないパラチェーンは、一度に1つまたは2つのスロットを利用すると想定されます。
パラチェーンスロットのリースを継続できなかったパラチェーンは、パラスレッドにダウングレードされます。
パラスレッド
パラスレッドは、パラチェーンの代替手段ですが、経済的モデルが異なります。手数料を払って一つのブロックにだけデータを格納するといったことができます。そのため、パラチェーンスロットを取得するコストよりも低く抑えられます。
パラスレッドは、完全なパラチェーンスロットを取得できない、または取得することが経済的に合理的でないが、リレーチェーンの共有セキュリティに参加したいチェーンに適しています。下記のようなアプリがパラスレッドに適していると考えられます。
Polkadotエコシステムに新規参入したいアプリ
ブロックへの書き込み頻度が少ないアプリ
パラスレッドとして接続するには、決められた額のDOTをデポジットして登録する必要があります。このデポジットは、期間の終了後に返却されます。登録によってトランザクションがリレーチェーンのブロックに含まれるという保証は必ずしもありません。登録後、リレーチェーンのブロックごとのオークションに参加します。オークションの参加にもDOTを支払う必要があります。あらかじめ、一部のパラチェーンスロットは、パラチェーンは接続されていなく、パラスレッドの勝者のために空いた状態になっています。ブロックごとのパラスレッドオークションで勝つと、このスペースにブロック候補を含めることができます。

###パラチェーンオークションの方法
概要
リレーチェーンブロック全てに組み込もうと考えるパラチェーンは、パラチェーンスロットを取得する必要があります。しかし、パラチェーンスロットの利用枠は限られています。そのためパラチェーンスロットは、キャンドルオークションという方式で販売されます。最終的に、100個のパラチェーンスロットを目標としています（パラチェーン用とパラスレッドプールに分割されます）。

キャンドルオークションの仕組み
キャンドルオークションとは、公開オークションの一種であり、オークション終了時の最高入札者が勝者とみなされます。キャンドルオークションの起源は、16世紀まで遡り、オークション実施期間を「キャンドルの長さ」としたことからその名が付けられました。ろうそくの火が消えると、オークションは終了し、その時点での最高入札者が勝者となります。
Polkadotのパラチェーンオークションでは、オークションの入札期間は知らされており、期間中は入札できます。知らされている入札期間が終わった後、Verifiable Random Function (VRF)によってランダムに決められた本当のオークションの終了時点が決定されます。こうすることで、周知の入札期間の終了間際に一斉に参加する現象は回避され、早期に入札するインセンティブを与えています。
スロットのリース期間は最長2年で、各スロットは6か月ごとに分割されます（1スロット4タームで2年間になります）。パラチェーンは、任意の連続した範囲でスロットを借りることができます。リースの期間が終了しても、どこかのスロットをパラチェーンが獲得していれば、そのパラチェーンは継続できます。

入札
パラチェーンスロットを獲得するには、20,000DOT以上を最大2年間デポジットする必要があります。具体的な入札方法を見てみましょう。

パラチェーンチームは、借りたいスロットのタームとデポジットするDOT金額を指定してオークションに入札できます。スロットのリース範囲は、1〜4タームの任意の連続範囲にすることができます。入札者は通常のアカウントの資金を使うことも、クラウドローン機能を使用してコミュニティからDOTを調達することもできます。パラチェーンスロットでデポジットしているDOTトークンは、ステーキングなど運用することはできません。DOTを運用する機会損失があることに注意しましょう。

入札者は、DOTの数量とタームを自由に設定して入札できます。オークションの勝敗は、パラチェーンスロットの2年間のうちのDOT数量と利用したい範囲の計算で決まります。
例えば、アリスは 80 DOTを①②③④の全期間で入札します。ボブは、110 DOTを①②の期間で入札します。ジョンは、50 DOTを③④の期間で入札します。
アリスは、80 * 4 = 320となります。ボブは、110 * 2 = 220で、ジョンは、60 * 2 = 120となります。もしこのスロットに3人しか参加しなかった場合、オークションでは①〜④の合計が最大となるように選ばれるため、ボブとジョンはこのスロットを共有することになります。アリスは合計320、ボブとジョンの合計は340となり、①②の範囲でボブ、③④の範囲でジョンはパラチェーンスロットを獲得します。
クラウドローン
入札者は、パラチェーンオークションの資金をクラウドローンで集めることもできます。クラウドローンとは、入札者がスロットの範囲（パラチェーンが入札する期間）、上限、および期間を公開して、コミュニティから資金を募ることです。支援者は、DOTを支援することができますが、オークションに失敗した時やリース期間が終了した時を除いてDOTを運用したり回収することができません。
クラウドローンを作成したパラチェーンは、支援者に対するリターンの内容を自由に決めることができます。

パラスレッドの参加方法
パラスレッドの参加要件
パラスレッドモデルでPolkadotエコシステムに参加するには、一定額のDOTをデポジットする必要があります。デポジットしたDOTは、パラスレッドの期間終了後に返却されます。パラチェーンスロットを獲得するにはかなりのDOTをデポジットする必要がありますが、パラスレッドは 50~100 DOTのデポジットで登録されます。

登録後、トランザクションをリレーチェーンに送るためには、パラスレッド同士のオークションで勝つ必要があります。これはEthereumの場合GAS代が高いトランザクションが早く組み込まれるのと同様で、手数料を一番高く払えるパラスレッドがトランザクションを送ることができます。ブロック毎に手数料のオークションに参加する必要があります。
パラスレッドの手数料オークション
コレーターは、リレーチェーンブロックの生成者にパラスレッドの入札を送信します。リレーチェーンブロックの生成者は、これらの入札から選択して、パラスレッドのブロックを取り込むことができます。ブロック生成者のインセンティブは、入札額が高いブロック候補を選んで手数料を多く貰うことです。パラスレッドの入札したDOTトークンは80:20の割合で分配されます。80％はPolkadot Treasury（Polkadotエコシステムの財源プール）に、20％がブロック生成者に送られます。この分配は、Polkadotの他の多くのパラメーターと同様に、ガバナンスメカニズムを介して変更することができます。
ブリッジ
ブロックチェーンブリッジは、2つのブロックチェーン同士の相互運用を可能にし、2つの経済主体を技術的にチェーンが相互に通信するための方法です。ブリッジの設計には、集権的なものから分散型のトラストレスなものまで種類があります。Polkadotでは、分散型のブリッジを推奨しますが、開発チームが集権的に設計することも可能ではあります。
現在、ブリッジの設計は計画が進んでいるようですが、実用化されたものはそれほど多くありません。開発は現在進行中と言えるでしょう。
ブリッジの方法
分散化されたトラストレスなブリッジの構築は、次のいずれかの方法で実行できます（推奨される方法で順序付けられています）。

 ブリッジパレット：Substrateで構築されたチェーンの場合は、ブリッジパレットを使用（どちらのネットワークのパラチェーンもSubstrateを使用する場合、例えばKusama⇆Polkadotブリッジ）。
スマートコントラクト：Substrateで構築されていないスタンドアローンチェーンの場合は、非Substrateチェーンにブリッジするスマートコントラクトが必要（例えば、Ethereumには、XCMPメッセージに基づいてETHトランザクションを開始するブリッジスマートコントラクトがあります）。
ハイ・オーダー・プロトコル：ブロックチェーンにスマートコントラクト（ビットコインなど）機能がない場合は、XClaim（暗号通貨を担保にした資産を使用して、トラストレスで効率的なクロスチェーンを実現するためのフレームワーク）または同様のプロトコルを使用してブリッジする必要があります。
